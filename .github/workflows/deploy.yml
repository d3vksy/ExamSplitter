name: Deploy ExamSplitter

on:
  push:
    branches:
      - main
      - master
      - beta
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: '1.0.0'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Extract version from commit message
      id: extract_version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $commitMessage = "${{ github.event.head_commit.message }}"
          if ($commitMessage -match "deploy\(([^)]+)\)") {
            $version = $matches[1]
          } else {
            echo "No deploy pattern found in commit message: $commitMessage"
            exit 1
          }
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"
        
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name ExamSplitter ^
          --add-data "models;models" ^
          --add-data "banner.png;." ^
          --icon "banner.png" ^
          --hidden-import ultralytics ^
          --hidden-import cv2 ^
          --hidden-import fitz ^
          --hidden-import PIL ^
          --hidden-import reportlab ^
          --hidden-import numpy ^
          --hidden-import tkinter ^
          --clean ^
          main.py
          
    - name: Create release package
      run: |
        $version = "${{ steps.extract_version.outputs.version }}"
        mkdir "ExamSplitter-v$version"
        copy dist\ExamSplitter.exe "ExamSplitter-v$version\"
        copy README.md "ExamSplitter-v$version\"
        copy LICENSE "ExamSplitter-v$version\"
        if exist models xcopy models "ExamSplitter-v$version\models\" /E /I
        Compress-Archive -Path "ExamSplitter-v$version\*" -DestinationPath "ExamSplitter-v$version.zip"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.extract_version.outputs.version }}
        name: ExamSplitter v${{ steps.extract_version.outputs.version }}
        body: |
          ## ğŸ‰ ExamSplitter v${{ steps.extract_version.outputs.version }}
          
          ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
          - **Windows**: `ExamSplitter-v${{ steps.extract_version.outputs.version }}.zip`
          
          ### ğŸš€ ì„¤ì¹˜ ë°©ë²•
          1. zip íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì••ì¶• í•´ì œ
          2. `ExamSplitter.exe` ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰
          
          ### âœ¨ ì£¼ìš” ê¸°ëŠ¥
          - ğŸ¤– PDF ì‹œí—˜ì§€ ë¬¸ì œ ìë™ ê°ì§€ (YOLOv8)
          - ğŸ–¼ï¸ ë‹¤ì–‘í•œ ì¶œë ¥ í˜•ì‹ ì§€ì›
          - ğŸ¨ ì§ê´€ì ì¸ GUI ì¸í„°í˜ì´ìŠ¤
          - âœï¸ ì‹¤ì‹œê°„ ë°•ìŠ¤ í¸ì§‘ ê¸°ëŠ¥
          
          ### ğŸ’» ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64bit)
          - ìµœì†Œ 4GB RAM
          - 500MB ì´ìƒì˜ ë””ìŠ¤í¬ ê³µê°„
          
          ### ğŸ“ ë³€ê²½ì‚¬í•­
          ìì„¸í•œ ë³€ê²½ì‚¬í•­ì€ [ì»¤ë°‹ íˆìŠ¤í† ë¦¬](https://github.com/${{ github.repository }}/commits)ë¥¼ í™•ì¸í•˜ì„¸ìš”.
        files: ExamSplitter-v${{ steps.extract_version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 