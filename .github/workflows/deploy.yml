name: Deploy ExamSplitter

on:
  push:
    branches:
      - main
      - master
      - beta
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: '1.0.0'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Extract version from commit message
      id: extract_version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $commitMessage = "${{ github.event.head_commit.message }}"
          if ($commitMessage -match "deploy\(([^)]+)\)") {
            $version = $matches[1]
          } else {
            echo "No deploy pattern found in commit message: $commitMessage"
            exit 1
          }
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"
        
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name ExamSplitter ^
          --add-data "models;models" ^
          --add-data "banner.png;." ^
          --icon "banner.png" ^
          --hidden-import ultralytics ^
          --hidden-import cv2 ^
          --hidden-import fitz ^
          --hidden-import PIL ^
          --hidden-import reportlab ^
          --hidden-import numpy ^
          --hidden-import tkinter ^
          --clean ^
          main.py
          
    - name: Create release package
      run: |
        $version = "${{ steps.extract_version.outputs.version }}"
        mkdir "ExamSplitter-v$version"
        copy dist\ExamSplitter.exe "ExamSplitter-v$version\"
        copy README.md "ExamSplitter-v$version\"
        copy LICENSE "ExamSplitter-v$version\"
        if exist models xcopy models "ExamSplitter-v$version\models\" /E /I
        Compress-Archive -Path "ExamSplitter-v$version\*" -DestinationPath "ExamSplitter-v$version.zip"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.extract_version.outputs.version }}
        name: ExamSplitter v${{ steps.extract_version.outputs.version }}
        body: |
          ## 🎉 ExamSplitter v${{ steps.extract_version.outputs.version }}
          
          ### 📥 다운로드
          - **Windows**: `ExamSplitter-v${{ steps.extract_version.outputs.version }}.zip`
          
          ### 🚀 설치 방법
          1. zip 파일을 다운로드하고 압축 해제
          2. `ExamSplitter.exe` 더블클릭으로 실행
          
          ### ✨ 주요 기능
          - 🤖 PDF 시험지 문제 자동 감지 (YOLOv8)
          - 🖼️ 다양한 출력 형식 지원
          - 🎨 직관적인 GUI 인터페이스
          - ✏️ 실시간 박스 편집 기능
          
          ### 💻 시스템 요구사항
          - Windows 10/11 (64bit)
          - 최소 4GB RAM
          - 500MB 이상의 디스크 공간
          
          ### 📝 변경사항
          자세한 변경사항은 [커밋 히스토리](https://github.com/${{ github.repository }}/commits)를 확인하세요.
        files: ExamSplitter-v${{ steps.extract_version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 